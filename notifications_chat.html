<!DOCTYPE html>
<html lang="ru" x-data="notificationsManager()" x-init="init()" x-cloak>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–≥–æ“≥–∏–Ω–æ–º–∞“≥–æ | TUT Connect</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <link rel="icon" type="image/png" href="logo.png">

    <style>
        :root {
            --primary-color: #007AFF; --success-color: #34C759; --warning-color: #FF9500;
            --primary-glow: rgba(0, 122, 255, 0.5); --success-glow: rgba(52, 199, 89, 0.5);
            --text-color: #f0f2f5; --text-secondary-color: #e0e2e5;
            --border-radius: 16px; --font-family: 'Inter', sans-serif;
            --background-color: #121212;
            --card-background: rgba(255, 255, 255, 0.08);
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-family); background: var(--background-color); color: var(--text-color); margin: 0; min-height: 100vh; position: relative; }
        
        /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–∏–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        *:focus { outline: none !important; box-shadow: none !important; }

        /* Dynamic background shapes */
        body::before, body::after {
            content: ''; position: fixed; z-index: -1; border-radius: 50%; filter: blur(100px); opacity: 0.6;
            animation: move-shape1 20s infinite alternate;
        }
        body::before {
            width: 400px; height: 400px; background: linear-gradient(135deg, var(--primary-color), #5856D6); top: -10%; left: -10%; 
        }
        body::after {
            width: 300px; height: 300px; background: linear-gradient(135deg, var(--success-color), var(--warning-color)); bottom: -10%; right: -5%; animation: move-shape2 25s infinite alternate;
        }

        @keyframes move-shape1 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(100px, 50px) rotate(180deg); } }
        @keyframes move-shape2 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(-80px, -40px) rotate(-180deg); } }

        .scroll-wrapper { padding: 25px 20px; }
        .container { width: 100%; max-width: 600px; margin: 0 auto; }
        .header-actions { display: flex; align-items: center; margin-bottom: 25px; }
        .btn-back { background: none; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; margin-right: 20px; }
        .btn-back:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .btn-back svg { width: 20px; height: 20px; color: var(--text-color); }
        h1 { color: #ffffff; margin: 0; font-weight: 700; font-size: 2.2rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2); flex-grow: 1; }

        .request-list-container {
            background: var(--card-background);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .request-item:last-child { border-bottom: none; }

        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
        .user-name { font-weight: 600; font-size: 1.1rem; }
        .user-email { font-size: 0.9rem; color: var(--text-secondary-color); }

        .actions button {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .actions .btn-accept {
            background-color: var(--success-color);
            color: #fff;
            margin-right: 10px;
        }
        .actions .btn-accept:hover { background-color: #2da44e; box-shadow: 0 0 10px var(--success-glow); }
        
        .actions .btn-reject {
            background-color: transparent;
            color: #FF5733;
            border: 1px solid rgba(255, 87, 51, 0.5);
        }
        .actions .btn-reject:hover { background-color: rgba(255, 87, 51, 0.1); }
        
        /* Skeleton Styles */
        .skeleton-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .skeleton-avatar { width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); }
        .skeleton-text { height: 12px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); margin-bottom: 5px; }
        .skeleton-btn { width: 70px; height: 35px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); }
        .animate-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 0.5; } 100% { opacity: 0.8; } }
        
        [x-cloak] { display: none !important; }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: #FF5733; }
    </style>
</head>
<body x-data="notificationsManager()" x-init="init()" x-cloak>
    
    <div x-show="$store.toast.visible" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         class="toast"
         :class="$store.toast.type === 'success' ? 'success' : 'error'"
         style="display: none;">
        <p x-text="$store.toast.message"></p>
    </div>

    <main class="scroll-wrapper">
        <div class="container">
            <div class="header-actions">
                <a href="chatlist.html" class="btn-back">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <h2>–û–≥–æ“≥–∏–Ω–æ–º–∞“≥–æ</h2>
            </div>
            
            <div class="request-list-container">
                <h3 style="font-size: 1.4rem; font-weight: 600; margin-bottom: 20px; color: #fff;">–ó–∞–ø—Ä–æ—Å—ã –≤ —á–∞—Ç</h3>
                
                <div x-show="isLoading" class="animate-pulse">
                    <template x-for="i in 3" :key="i">
                        <div class="skeleton-item">
                            <div class="user-info">
                                <div class="skeleton-avatar"></div>
                                <div>
                                    <div class="skeleton-text" style="width: 110px;"></div>
                                    <div class="skeleton-text" style="width: 160px;"></div>
                                </div>
                            </div>
                            <div class="actions" style="display: flex; gap: 10px;">
                                <div class="skeleton-btn"></div>
                                <div class="skeleton-btn"></div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <ul x-show="!isLoading && requests.length > 0">
                    <template x-for="req in requests" :key="req.uid">
                        <li class="request-item">
                            <div class="user-info">
                                <img :src="req.photoURL || 'userphoto.jpg'" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
                                <div>
                                    <div class="user-name" x-text="req.displayName"></div>
                                    <div class="user-email" x-text="req.email"></div>
                                </div>
                            </div>
                            <div class="actions">
                                <button @click="acceptRequest(req.uid)" class="btn-accept">–ü—Ä–∏–Ω—è—Ç—å</button>
                                <button @click="rejectRequest(req.uid)" class="btn-reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                            </div>
                        </li>
                    </template>
                </ul>

                <p x-show="!isLoading && requests.length === 0" style="text-align:center; color:rgba(255, 255, 255, 0.7); padding: 20px 0;">
                    “≤–∞–Ω”Ø–∑ –¥–∞—Ä—Ö–æ—Å—Ç“≥–æ–∏ —á–∞—Ç –≤—É“∑—É–¥ –Ω–∞–¥–æ—Ä–∞–Ω–¥.
                </p>
            </div>
            
            </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
             const firebaseConfig = {
                        apiKey: "AIzaSyCAOfxPW5m2UqtulWzuh3egOjJ-ti-rDf8",
                        authDomain: "register-221e5.firebaseapp.com",
                        databaseURL: "https://register-221e5-default-rtdb.firebaseio.com",
                        projectId: "register-221e5",
                        storageBucket: "register-221e5.appspot.com",
                        messagingSenderId: "588640206529",
                        appId: "1:588640206529:web:b2abf5413387e251935e40"
                    };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // üü¢ –°–∏—Å—Ç–µ–º–∞ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (—Ñ—É–Ω–∫—Ü–∏—è)
        function setupPresence(user) {
            if (!user) return;
            const uid = user.uid;
            const userLastOnlineRef = database.ref('/users/' + uid + '/lastOnline');
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userLastOnlineRef.set(firebase.database.ServerValue.TIMESTAMP);
                    userLastOnlineRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
        }
        
        document.addEventListener('alpine:init', () => {
             // Toast Store
            Alpine.store('toast', {
                visible: false, message: '', type: 'success', timer: null,
                show(message, type = 'success') {
                    this.message = message; this.type = type; this.visible = true;
                    clearTimeout(this.timer);
                    this.timer = setTimeout(() => this.visible = false, 4000);
                }
            });
            
            Alpine.data('notificationsManager', () => ({
                isLoading: true, currentUser: null, requests: [],

                init() {
                    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞)
                    setupBlocking(); 
                    
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            this.currentUser = user;
                            this.loadRequests();
                            setupPresence(user); 
                        } else {
                            window.location.href = 'index.html'; 
                        }
                    });
                },

                async loadRequests() {
                    this.isLoading = true;
                    const requestsRef = database.ref(`chat_requests/${this.currentUser.uid}`);
                    requestsRef.on('value', async (snapshot) => {
                        if (!snapshot.exists()) { this.isLoading = false; this.requests = []; return; }
                        const requestUids = Object.keys(snapshot.val());
                        let reqs = [];
                        
                        for (const uid of requestUids) {
                            const userSnap = await database.ref(`users/${uid}`).once('value');
                            if (userSnap.exists()) { reqs.push({ uid, ...userSnap.val() }); }
                        }
                        this.requests = reqs;
                        this.isLoading = false;
                    });
                },

                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ACCEPT (–î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–∞–≤–∏–ª)
                acceptRequest(senderId) {
                    const myUid = this.currentUser.uid;
                    const conversationId = [myUid, senderId].sort().join('_');
                    const timestamp = firebase.database.ServerValue.TIMESTAMP;
                    const displayName = this.requests.find(r => r.uid === senderId)?.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                    // 1. –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø: –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –∏ –∑–∞–ø–∏—Å—å –≤ –°–í–û–ò —É–∑–ª—ã
                    const step1Updates = {};
                    step1Updates[`/conversations/${conversationId}/participants/${myUid}`] = true;
                    step1Updates[`/conversations/${conversationId}/participants/${senderId}`] = true;
                    step1Updates[`/conversations/${conversationId}/createdAt`] = timestamp;
                    step1Updates[`/user_conversations/${myUid}/${conversationId}`] = true; // –°–í–û–ô —É–∑–µ–ª
                    step1Updates[`/chat_requests/${myUid}/${senderId}`] = null;

                    database.ref().update(step1Updates)
                        .then(() => {
                            // 2. –í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø: –ó–∞–ø–∏—Å—å –≤ –ß–£–ñ–û–ô —É–∑–µ–ª (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏, —Ç.–∫. —á–∞—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω)
                            return database.ref(`/user_conversations/${senderId}/${conversationId}`).set(true);
                        })
                        .then(() => { 
                            Alpine.store('toast').show(`–ß–∞—Ç —Å ${displayName} —Å–æ–∑–¥–∞–Ω!`, 'success');
                            setTimeout(() => {
                                window.location.href = `chat.html?uid=${senderId}`;
                            }, 500);
                        })
                        .catch((err) => {
                            Alpine.store('toast').show(`–û—à–∏–±–∫–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –ë–î.`, 'error');
                            console.error("Critical RTDB Error:", err);
                        });
                },

                rejectRequest(senderId) {
                    const displayName = this.requests.find(r => r.uid === senderId)?.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    database.ref(`chat_requests/${this.currentUser.uid}/${senderId}`).remove()
                        .then(() => {
                            Alpine.store('toast').show(`–ó–∞–ø—Ä–æ—Å –æ—Ç ${displayName} –æ—Ç–∫–ª–æ–Ω–µ–Ω.`, 'success');
                        });
                },
            }));
        });
        
        // --- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ JS-—Ñ—É–Ω–∫—Ü–∏—é) ---
        function setupBlocking() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
            document.addEventListener('keydown', function(e) { 
                if (e.key === 'F12' || (e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.key === 'c')) { e.preventDefault(); } 
            });
        }
    </script>
</body>

</html>
