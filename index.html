<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5856D6">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=DM+Sans:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary: #5856D6; --accent: #007AFF; --bg: #F5F5FF; --text: #1C1C1E;
            --heading: #12073A; --button-bg: #5856D6; --button-text: #FFFFFF;
            --button-hover: #4F4DC2; --card-bg: #FFFFFF; --border: #BAB9EB;
            --row-hover: #DCDCF5; --text-light: #5A588A; --skeleton-bg: rgba(186, 185, 235, 0.5);
            --glass-blur: none; --glass-border: none; --bg-image: none;
        }
        body {
            font-family: 'Poppins', sans-serif; font-size: 18px; background-color: var(--bg);
            color: var(--text); padding: 10px; width: 100%; overflow-x: hidden;
            min-height: 100vh; background-image: var(--bg-image); background-size: cover;
            background-position: center; background-attachment: fixed; transition: all 0.3s ease;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none;     /* IE 10+ and Edge */
            user-select: none;      
        }
        button, a, select, .color-option {
            -webkit-tap-highlight-color: transparent;
        }
        button:focus, a:focus, select:focus, .color-option:focus, 
        button:focus-visible, a:focus-visible, select:focus-visible, .color-option:focus-visible {
            outline: none;
        }
        h1 { font-family: 'DM Sans', sans-serif; text-align: center; margin-bottom: 15px; font-size: 23px; color: var(--heading); }
        .btn { padding: 8px 12px; border-radius: 20px; font-weight: 500; cursor: pointer; border: none; background: var(--button-bg); color: var(--button-text); font-size: 14px; }
        .back { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; background-color: var(--card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); }
        .back:hover { transform: translateY(-2px); }
        .group-info { text-align: center; font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.8rem; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; border: var(--glass-border); }
        .modal-content h2 { margin-bottom: 15px; font-size: 1rem; }
        .controls-modal { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .controls-modal select, #audFacultyFilter { width: 100%; padding: 10px; border-radius: 22px; border: 2px solid var(--primary); background-color: var(--card-bg); font-size: 14px; color: var(--text); font-weight: 500; }
        .voice-assistant { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .voice-btn { width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; border: none; transition: all 0.3s ease; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); }
        .voice-btn:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
        .voice-btn.listening { animation: pulse 1.5s infinite; background-color: var(--accent); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .voice-status { position: absolute; bottom: 65px; right: 0; background-color: var(--card-bg); padding: 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 250px; display: none; font-size: 13px; color: var(--text); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: var(--glass-border); }
        .voice-status.listening { display: block; animation: fadeIn 0.3s ease; }
        .voice-status .assistant-response { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-style: italic; color: var(--primary); }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; gap: 10px; }
        .buttons {
            display: flex; justify-content: space-around; align-items: center;
            width: 92%; min-height: 45px; margin: 15px auto; padding: 6px;
            border-radius: 30px; background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .buttons button {
            height: 35px; padding: 0 10px; line-height: 35px; background-color: transparent;
            color: var(--text); border: none; border-radius: 20px; font-weight: 600; font-size: 14px;
            cursor: pointer; flex-grow: 0; min-width: auto; transition: all 0.3s ease;
            box-shadow: none; position: relative; overflow: hidden;
        }
        .buttons button:hover {
            background-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px);
        }
        .buttons button.active-day {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.1));
            color: var(--heading, #000);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2), inset 0px -2px 4px rgba(255, 255, 255, 0.5);
            transform: translateY(-2px) scale(1.05); border: 1px solid rgba(255, 255, 255, 0.7);
        }
        .schedule-container { width: 100%; margin-top: 8px; }
        .schedule-day { width: 100%; display: none; background-color: var(--card-bg); color: var(--text); border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); animation: fadeIn 0.5s ease-in-out; overflow: hidden; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: var(--glass-border); }
        .active { display: block; }
        .schedule-day h2 { padding: 15px; background-color: var(--primary); color: white; margin: 0; border-radius: 12px 12px 0 0; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 16px; }
        th { background-color: var(--primary); color: white; font-weight: 500; position: sticky; top: 0; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); }
        tr:hover { background-color: var(--row-hover); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .theme-card { background-color: var(--card-bg); padding: 12px; margin: 15px 0; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: var(--glass-border); }
        .theme-card h3 { margin-bottom: 10px; color: var(--heading); text-align: center; font-size: 1.1rem; }
        .color-palette { display: flex; overflow-x: auto; gap: 8px; padding: 8px 4px; scrollbar-width: thin; scrollbar-color: var(--primary) var(--card-bg); }
        .color-palette::-webkit-scrollbar { height: 5px; }
        .color-palette::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 13px; }
        .color-palette::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 20px; }
        .color-option { flex: 0 0 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .color-option::after { content: '✔'; font-size: 20px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s ease; }
        .color-option.selected::after { opacity: 1; }
        .color-option:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .color-name { position: absolute; bottom: 3px; left: 0; right: 0; text-align: center; font-size: 9px; font-weight: 500; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .samsung-red { background: linear-gradient(150deg, #ffd9d9, #ff0000); } .samsung-orange { background: linear-gradient(150deg, #f5d295, #e69109); } .samsung-yellow { background: linear-gradient(150deg, #f2e6ce, #d9ce02); } .samsung-green { background: linear-gradient(150deg, #def0d8, #02d902); } .samsung-mint { background: linear-gradient(150deg, #797d80, #000000); } .samsung-teal { background-color: #30B0C7; } .samsung-cyan { background-color: #32ADE6; } .samsung-blue { background-color: #007AFF; } .samsung-indigo { background-color: #5856D6; } .samsung-purple { background-color: #AF52DE; } .samsung-pink { background-color: #FF2D55; } .samsung-brown { background-color: #A2845E; } .samsung-gray { background-color: #8E8E93; } .glass-theme { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        footer { text-align: center; margin-top: 30px; padding: 15px; color: var(--text-light); font-size: 13px; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 30px; background-color: var(--card-bg); border: var(--glass-border); }
        #update-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); opacity: 0;
            background-color: var(--card-bg); color: var(--text); padding: 1rem; border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; display: flex; align-items: center; gap: 1rem;
            transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease;
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border); pointer-events: none;
        }
        #update-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .toast-icon {
            flex-shrink: 0; width: 40px; height: 40px; background-color: var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: var(--button-text);
        }
        .toast-message p { margin: 0; line-height: 1.3; }
        .toast-message .title { font-weight: 600; font-size: 1rem; }
        .toast-message .subtitle { font-size: 0.8rem; opacity: 0.7; }
        .toast-actions { display: flex; gap: 0.5rem; }
        .toast-actions button {
            border: none; padding: 8px 14px; border-radius: 1rem;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        #update-later-btn { background-color: var(--row-hover); color: var(--text-light); }
        #update-later-btn:hover { background-color: var(--border); }
        #update-now-btn { background-color: var(--accent); color: var(--button-text); }
        #update-now-btn:hover { filter: brightness(1.1); }
        @media (max-width: 768px) {
            body { font-size: 16px; } h1 { font-size: 20px; } th, td { font-size: 14px; }
            .buttons button { font-size: 14px; padding: 0 10px;}
            #update-toast.show { bottom: 20px; width: calc(100% - 2rem); }
        }
        @media (min-width: 769px) { .desktop-back-btn { display: flex; width: 100%; justify-content: flex-start; } }
    </style>
</head>
<body>
    <div id="selectionModal" class="modal">
        <div class="modal-content">
            <h2>Выберите ваше расписание</h2>
            <div class="controls-modal">
                <select id="facultySelect"></select>
                <select id="courseSelect"></select>
                <select id="groupSelect"></select>
            </div>
            <button id="saveSelectionBtn" class="btn" disabled>Показать расписание</button>
        </div>
    </div>

    <h1>Ҷадвали дарсҳо</h1>
    <div id="group-info-display" class="group-info"></div>
    <div class="theme-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin-bottom: 0;">Палитра цветов UI</h3>
            <button id="findFreeAudBtn" class="btn" style="padding: 6px 10px; font-size: 12px;">Свободные ауд.</button>
        </div>
        <div class="color-palette"></div>
    </div>
    <div class="controls"><button id="changeGroupBtn" class="btn">Сменить группу</button></div>
    <div class="buttons"></div>
    <div id="scheduleContainer" class="schedule-container"></div>
    <footer>
        <p>© 2025. Расписание.ДТТ. Душанбе.</p>
        <p>Разработчик : Komron Sharipov ™</p>     
    </footer>

    <div class="voice-assistant">
        <div class="voice-status" id="voiceStatus"></div>
        <button class="voice-btn" id="voiceBtn" title="Голосовой помощник">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>
    </div>
    
    <div id="update-toast">
        <div class="toast-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 14V3"/></svg>
        </div>
        <div class="toast-message">
            <p class="title">Доступно обновление</p>
            <p class="subtitle">Расписание было изменено.</p>
        </div>
        <div class="toast-actions">
            <button id="update-later-btn">Позже</button>
            <button id="update-now-btn">Обновить</button>
        </div>
    </div>

    <div id="freeAudModal" class="modal">
        <div class="modal-content">
            <h2 id="freeAudModalTitle">Свободные аудитории</h2>
            <div style="margin-bottom: 15px;">
                <select id="audFacultyFilter">
                    <option value="all">Все факультеты</option>
                </select>
            </div>
            <div id="freeAudList" style="text-align: left; max-height: 300px; overflow-y: auto; margin: 15px 0; padding: 0 10px; font-size: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
            </div>
            <button id="closeFreeAudModalBtn" class="btn">Закрыть</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB3_Qs3pr6OK2JvyL7ViO09aFXjjt9qygQ",
            authDomain: "tut-app-6aaae.firebaseapp.com",
            databaseURL: "https://tut-app-6aaae-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tut-app-6aaae",
            storageBucket: "tut-app-6aaae.appspot.com",
            messagingSenderId: "726613480112",
            appId: "1:726613480112:web:6e55cfb767ec8f6c5d6175",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let hierarchy = {}, allSchedules = {}, currentSchedule = {}, currentDay = '', recognition;
        let toastHideTimeout = null;
        const $ = (selector) => document.querySelector(selector);
        const facultySelect = $('#facultySelect'), courseSelect = $('#courseSelect'), groupSelect = $('#groupSelect');
        const daysOfWeek = ['Душанбе', 'Сешанбе', 'Чоршанбе', 'Панҷшанбе', 'Ҷумъа', 'Шанбе'];
        const dayMapping = { 'понедельник': 'Душанбе', 'вторник': 'Сешанбе', 'среду': 'Чоршанбе', 'четверг': 'Панҷшанбе', 'пятницу': 'Ҷумъа', 'субботу': 'Шанбе' };
        const samsungThemes = {
            glass: {"--bg": "rgba(255,255,255,0.1)", "--text": "#ffffff", "--heading": "#ffffff", "--primary": "rgba(255,255,255,0.01)", "--accent": "rgba(255,255,255,0.7)", "--button-bg": "rgba(255,255,255,0.1)", "--button-text": "#ffffff", "--button-hover": "rgba(255,255,255,0.2)", "--card-bg": "rgba(255,255,255,0.1)", "--border": "rgba(255,255,255,0.1)", "--row-hover": "rgba(255,255,255,0.1)", "--text-light": "rgba(255,255,255,0.7)", "--skeleton-bg": "rgba(255,255,255,0.2)", "--glass-blur": "blur(13px)", "--glass-border": "1px solid rgba(255,255,255,0.2)", "--bg-image": "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://raw.githubusercontent.com/Komronbek11/jadvalidarsi/refs/heads/main/neon2.jpg')"},
            red: {"--bg": "#ffe0e0", "--text": "black", "--heading": "#1F040A", "--primary": "#FF3B30", "--accent": "#E0352B", "--button-bg": "#FF3B30", "--button-text": "black", "--button-hover": "#E0352B", "--card-bg": "#dbb4b4", "--border": "#FFD6D4", "--row-hover": "#FFEAE9", "--text-light": "black", "--skeleton-bg": "rgba(255, 214, 212, 0.5)", "--glass-blur": "none", "--glass-border": "none", "--bg-image": "none"},
            orange: {"--bg": "#FFF5ED", "--text": "black", "--heading": "black", "--primary": "#FF9500", "--accent": "#E08500", "--button-bg": "#FF9500", "--button-text": "black", "--button-hover": "#E08500", "--card-bg": "#e8d399", "--border": "#FFD9A6", "--row-hover": "#FFEDD3", "--text-light": "#8A5D3D", "--skeleton-bg": "rgba(255, 217, 166, 0.5)", "--glass-blur": "none", "--glass-border": "none", "--bg-image": "none"},
            yellow: {"--bg": "#d6c79f", "--text": "#3A3007", "--heading": "#1F1904", "--primary": "#FFCC00", "--accent": "#E0B800", "--button-bg": "#FFCC00", "--button-text": "#3A3007", "--button-hover": "#E0B800", "--card-bg": "#ffeebf", "--border": "#FFE680", "--row-hover": "#FFF2BF", "--text-light": "black", "--skeleton-bg": "rgba(255, 230, 128, 0.5)", "--glass-blur": "none", "--glass-border": "none", "--bg-image": "none"},
            green: {"--bg": "#DEF2BF", "--text": "#0A3A1D", "--heading": "#051F10", "--primary": "#34C759", "--accent": "#2DB350", "--button-bg": "#34C759", "--button-text": "#FFFFFF", "--button-hover": "#2DB350", "--card-bg": "#E7F0D8", "--border": "#B8EBC5", "--row-hover": "#DBF5E2", "--text-light": "#4D8A62", "--skeleton-bg": "rgba(184, 235, 197, 0.5)", "--glass-blur": "none", "--glass-border": "none", "--bg-image": "none"},
            mint: {"--bg": "black", "--text": "white", "--heading": "white", "--primary": "#2b2b2b", "--accent": "#1768ff", "--button-bg": "#1768ff", "--button-text": "white", "--button-hover": "green", "--card-bg": "#2b2b2b", "--border": "rgba(255,255,255,0.1)", "--row-hover": "#2b2b2b", "--text-light": "yellow", "--skeleton-bg": "rgba(153, 232, 228, 0.5)", "--glass-blur": "none", "--glass-border": "yellow", "--bg-image": "url('sky.jpg')"},
            indigo: {"--bg": "#F5F5FF", "--text": "#12073A", "--heading": "#0A041F", "--primary": "#5856D6", "--accent": "#4F4DC2", "--button-bg": "#5856D6", "--button-text": "#FFFFFF", "--button-hover": "#4F4DC2", "--card-bg": "#FFFFFF", "--border": "#BAB9EB", "--row-hover": "#DCDCF5", "--text-light": "#5A588A", "--skeleton-bg": "rgba(186, 185, 235, 0.5)", "--glass-blur": "none", "--glass-border": "none", "--bg-image": "none"},
        };

        function applySamsungTheme(themeName) {
            const theme = samsungThemes[themeName];
            if (!theme) return;
            Object.entries(theme).forEach(([key, value]) => document.documentElement.style.setProperty(key, value));
            localStorage.setItem("selectedTheme", themeName);
            document.querySelectorAll(".color-option").forEach(el => el.classList.remove("selected"));
            const currentThemeEl = document.querySelector(`.color-option[data-theme="${themeName}"]`);
            if (currentThemeEl) currentThemeEl.classList.add("selected");
        }
        function populateThemeButtons() {
            const palette = document.querySelector('.color-palette');
            palette.innerHTML = Object.keys(samsungThemes).map(key => {
                const name = key.charAt(0).toUpperCase() + key.slice(1);
                let displayName = key === 'glass' ? 'Glass' : (key === 'mint' ? 'Тёмная' : name);
                return `<div class="color-option ${key === 'glass' ? 'glass-theme' : `samsung-${key}`}" data-theme="${key}" onclick="applySamsungTheme('${key}')"><span class="color-name">${displayName}</span></div>`;
            }).join('');
        }
        function populateDayButtons() {
            const buttonContainer = document.querySelector('.buttons');
            const dayAbbreviations = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            buttonContainer.innerHTML = daysOfWeek.map((day, index) => 
                `<button data-day="${day}" onclick="showDay('${day}')">${dayAbbreviations[index] || day}</button>`
            ).join('');
        }
        function showUpdateToast() {
            clearTimeout(toastHideTimeout);
            $('#update-toast').classList.add('show');
            toastHideTimeout = setTimeout(hideUpdateToast, 15000);
        }
        function hideUpdateToast() {
            clearTimeout(toastHideTimeout);
            $('#update-toast').classList.remove('show');
        }
        function applyUpdates() {
            hierarchy = JSON.parse(localStorage.getItem('cachedHierarchy'));
            allSchedules = JSON.parse(localStorage.getItem('cachedSchedules'));
            const savedPath = JSON.parse(localStorage.getItem('schedulePath'));
            populateFaculties();
            if(savedPath) {
                facultySelect.value = savedPath.f;
                populateCourses(savedPath.c);
                populateGroups(savedPath.g);
            }
            updateScheduleView();
            hideUpdateToast();
        }
        async function loadData() {
            populateThemeButtons();
            populateDayButtons();
            applySamsungTheme(localStorage.getItem("selectedTheme") || 'indigo');
            const cachedHierarchy = localStorage.getItem('cachedHierarchy');
            const cachedSchedules = localStorage.getItem('cachedSchedules');
            let isCacheAvailable = cachedHierarchy && cachedSchedules;
            if (isCacheAvailable) {
                hierarchy = JSON.parse(cachedHierarchy);
                allSchedules = JSON.parse(cachedSchedules);
                initializeApp();
            }
            if (navigator.onLine) {
                try {
                    const [hierarchySnapshot, schedulesSnapshot] = await Promise.all([
                        db.ref('hierarchy').once('value'),
                        db.ref('schedules').once('value')
                    ]);
                    if (!hierarchySnapshot.exists() || !schedulesSnapshot.exists()) throw new Error("Data not found in Firebase.");
                    const freshHierarchyStr = JSON.stringify(hierarchySnapshot.val());
                    const freshSchedulesStr = JSON.stringify(schedulesSnapshot.val());
                    if (!isCacheAvailable || freshHierarchyStr !== cachedHierarchy || freshSchedulesStr !== cachedSchedules) {
                        localStorage.setItem('cachedHierarchy', freshHierarchyStr);
                        localStorage.setItem('cachedSchedules', freshSchedulesStr);
                        if (isCacheAvailable) showUpdateToast();
                        else {
                            hierarchy = hierarchySnapshot.val();
                            allSchedules = schedulesSnapshot.val();
                            initializeApp();
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch fresh data:", e);
                    if (!isCacheAvailable) document.body.innerHTML = '<h1>Ошибка загрузки. Проверьте интернет.</h1>';
                }
            } else if (!isCacheAvailable) {
                 document.body.innerHTML = '<h1>Нет сети и нет сохраненных данных.</h1>';
            }
        }
        function initializeApp() {
            populateFaculties();
            initVoiceRecognition();
            const savedPath = localStorage.getItem('schedulePath');
            if (savedPath) {
                const pathIds = JSON.parse(savedPath);
                facultySelect.value = pathIds.f;
                populateCourses(pathIds.c);
                populateGroups(pathIds.g);
                updateScheduleView(); 
            } else {
                $('#selectionModal').classList.add('active');
            }
        }
        function populateFaculties() { facultySelect.innerHTML = "<option value=''>Факультет</option>"; for (const id in hierarchy) facultySelect.add(new Option(hierarchy[id].name, id)); }
        function populateCourses(selectedId = null) {
            const facultyId = facultySelect.value;
            courseSelect.innerHTML = "<option value=''>Курс</option>";
            if (!facultyId) return populateGroups();
            const faculty = hierarchy[facultyId];
            if (faculty?.courses) Object.keys(faculty.courses).forEach(id => courseSelect.add(new Option(faculty.courses[id].name, id)));
            if (selectedId) courseSelect.value = selectedId;
        }
        function populateGroups(selectedId = null) {
            const facultyId = facultySelect.value, courseId = courseSelect.value;
            groupSelect.innerHTML = "<option value=''>Группа</option>";
            if (!courseId) return;
            const course = hierarchy[facultyId]?.courses?.[courseId];
            if (course?.groups) Object.keys(course.groups).forEach(id => groupSelect.add(new Option(course.groups[id].name, id)));
            if (selectedId) groupSelect.value = selectedId;
        }
        facultySelect.addEventListener('change', () => populateCourses());
        courseSelect.addEventListener('change', () => populateGroups());
        groupSelect.addEventListener('change', () => { $('#saveSelectionBtn').disabled = !groupSelect.value; });
        $('#changeGroupBtn').addEventListener('click', () => $('#selectionModal').classList.add('active'));
        $('#saveSelectionBtn').addEventListener('click', () => {
            const pathIds = { f: facultySelect.value, c: courseSelect.value, g: groupSelect.value };
            if (!pathIds.g) return;
            const info = `${facultySelect.options[facultySelect.selectedIndex].text}, ${courseSelect.options[courseSelect.selectedIndex].text}, ${groupSelect.options[groupSelect.selectedIndex].text}`;
            localStorage.setItem('schedulePath', JSON.stringify(pathIds));
            localStorage.setItem('scheduleInfo', info);
            $('#selectionModal').classList.remove('active');
            // ИСПРАВЛЕНО: Удалена ошибочная логика с #mainContent
            updateScheduleView();
        });
        function updateScheduleView() {
            const pathIds = JSON.parse(localStorage.getItem('schedulePath') || '{}');
            if (!pathIds.g) return renderNoGroupSelected();
            currentSchedule = allSchedules?.[pathIds.f]?.[pathIds.c]?.[pathIds.g] || {};
            $('#group-info-display').textContent = localStorage.getItem('scheduleInfo') || '';
            let todayIndex = new Date().getDay();
            todayIndex = todayIndex === 0 ? 5 : todayIndex - 1;
            if (todayIndex >= daysOfWeek.length) todayIndex = 0;
            showDay(daysOfWeek[todayIndex]);
        }
        function showDay(dayName) {
            currentDay = dayName;
            const daySchedule = currentSchedule[currentDay] || [];
            if (daySchedule.length === 0 || daySchedule.every(item => !item.subject?.trim() || !item.aud?.trim())) renderNoClasses();
            else renderSchedule(daySchedule);
            document.querySelectorAll('.buttons button').forEach(btn => btn.classList.toggle('active-day', btn.dataset.day === currentDay));
        }
        function renderNoGroupSelected() { $('#scheduleContainer').innerHTML = `<div class="schedule-day active" style="text-align: center; padding: 20px;">Пожалуйста, выберите группу.</div>`; }
        function renderNoClasses() { $('#scheduleContainer').innerHTML = `<div class="schedule-day active"><h2>${currentDay}</h2><p style="padding: 20px; text-align: center;">Дарсҳо нестанд. Шумо метавонед истироҳат кунед!</p></div>`; }
        function renderSchedule(schedule) {
            let html = `<div class="schedule-day active"><h2>${currentDay}</h2><table><thead><tr><th>Вақт</th><th>АУД</th><th>Фан</th></tr></thead><tbody>`;
            schedule.forEach(item => {
                if (item.subject?.trim() && item.aud?.trim()) {
                    const time = item.startTime && item.endTime ? `${item.startTime} - ${item.endTime}` : (item.time || '---');
                    html += `<tr><td>${time}</td><td>${item.aud}</td><td>${item.subject}</td></tr>`;
                }
            });
            $('#scheduleContainer').innerHTML = html + `</tbody></table></div>`;
        }
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return console.warn("Распознавание речи не поддерживается.");
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;
            recognition.onresult = (event) => processVoiceCommand(event.results[0][0].transcript.toLowerCase().trim());
            recognition.onend = () => $('#voiceBtn').classList.remove('listening');
            $('#voiceBtn').addEventListener('click', () => { recognition.start(); $('#voiceBtn').classList.add('listening'); });
        }
        async function processVoiceCommand(command) { /* ... Voice command logic ... */ }
        function speak(text) { try { speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'ru-RU'; speechSynthesis.speak(utterance); } catch (e) { console.error("Speech synthesis error:", e); } }
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered.')).catch(err => console.error('SW registration failed:', err)); }); }

        // --- НОВАЯ И УЛУЧШЕННАЯ ЛОГИКА ДЛЯ СВОБОДНЫХ АУДИТОРИЙ ---

        function findFreeAuditoriums(facultyFilterId = 'all') {
            const now = new Date();
            const todayIndex = now.getDay() === 0 ? 5 : now.getDay() - 1;
            if (todayIndex < 0 || todayIndex >= daysOfWeek.length) {
                return { message: "Сегодня выходной, все аудитории свободны." };
            }
            const currentDayName = daysOfWeek[todayIndex];
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const allAuds = new Set();
            const occupiedAuds = new Set();
            
            // Определяем, какие факультеты сканировать
            const facultiesToScan = facultyFilterId === 'all'
                ? Object.keys(allSchedules)
                : [facultyFilterId];

            for (const facultyId of facultiesToScan) {
                if (!allSchedules[facultyId]) continue;
                for (const courseId in allSchedules[facultyId]) {
                    for (const groupId in allSchedules[facultyId][courseId]) {
                        const groupSchedule = allSchedules[facultyId][courseId][groupId];
                        // Сбор всех аудиторий
                        for (const day in groupSchedule) {
                            groupSchedule[day].forEach(lesson => {
                                if (lesson.aud?.trim()) allAuds.add(lesson.aud.trim());
                            });
                        }
                        // Сбор занятых аудиторий на сегодня и текущее время
                        const todayLessons = groupSchedule[currentDayName] || [];
                        todayLessons.forEach(lesson => {
                            if (lesson.aud?.trim() && lesson.startTime && lesson.endTime) {
                                if (currentTime >= lesson.startTime && currentTime < lesson.endTime) {
                                    occupiedAuds.add(lesson.aud.trim());
                                }
                            }
                        });
                    }
                }
            }
            
            if (allAuds.size === 0) return { message: "Список аудиторий для данного факультета пуст." };
            
            const allAudsArray = Array.from(allAuds).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            const freeAuds = allAudsArray.filter(aud => !occupiedAuds.has(aud));
            return { free: freeAuds, message: null };
        }

        function updateFreeAudList() {
            const facultyFilterId = $('#audFacultyFilter').value;
            const result = findFreeAuditoriums(facultyFilterId);
            const listContainer = $('#freeAudList');
            const modalTitle = $('#freeAudModalTitle');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            modalTitle.textContent = `Свободные аудитории (${timeStr})`;
            listContainer.innerHTML = '';
            
            if (result.message) {
                listContainer.style.display = 'block';
                listContainer.innerHTML = `<p style="text-align: center; grid-column: 1 / -1;">${result.message}</p>`;
            } else if (result.free.length === 0) {
                listContainer.style.display = 'block';
                listContainer.innerHTML = `<p style="text-align: center; grid-column: 1 / -1;">В данный момент свободных аудиторий нет.</p>`;
            } else {
                listContainer.style.display = 'grid';
                listContainer.innerHTML = result.free
                    .map(aud => `<div style="background-color: var(--row-hover); padding: 8px; border-radius: 10px; text-align: center;">${aud}</div>`)
                    .join('');
            }
        }
        
        function setupAndShowFreeAudModal() {
            const facultyFilterSelect = $('#audFacultyFilter');
            // Заполняем список факультетов, только если он пуст
            if (facultyFilterSelect.options.length <= 1) {
                for (const id in hierarchy) {
                    facultyFilterSelect.add(new Option(hierarchy[id].name, id));
                }
            }
            updateFreeAudList(); // Обновляем список при открытии
            $('#freeAudModal').classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            $('#update-now-btn').addEventListener('click', applyUpdates);
            $('#update-later-btn').addEventListener('click', hideUpdateToast);
            
            // Назначаем обработчики для модального окна аудиторий
            $('#findFreeAudBtn').addEventListener('click', setupAndShowFreeAudModal);
            $('#audFacultyFilter').addEventListener('change', updateFreeAudList);
            $('#closeFreeAudModalBtn').addEventListener('click', () => {
                $('#freeAudModal').classList.remove('active');
            });
            
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) || (e.ctrlKey && e.key.toUpperCase() === 'U') || (e.ctrlKey && e.key.toUpperCase() === 'C')) {
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>
