<!DOCTYPE html>
<html lang="ru" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="displayName || '–ß–∞—Ç'">–ß–∞—Ç</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <link rel="icon" type="image/png" href="logo.png">

    <style>
        /* --- –î–∏–∑–∞–π–Ω-—Ç–æ–∫–µ–Ω—ã --- */
        :root { --bg-light: #f0f2f5; --bg-dark: #121212; --card-light: #ffffff; --card-dark: #1f1f1f; --shadow-light: rgba(189, 200, 213, 0.4), rgba(255, 255, 255, 0.9); --shadow-dark: rgba(0, 0, 0, 0.6), rgba(35, 35, 35, 0.5); --primary-color: #5d50f8; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: #1f2937; transition: all 0.5s ease; }
        .dark { background-color: var(--bg-dark); color: #e5e7eb; }
        .bento-card { background-color: var(--card-light); box-shadow: 8px 8px 15px var(--shadow-light), -8px -8px 15px var(--shadow-light); border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.3s ease; }
        .dark .bento-card { background-color: rgba(31, 31, 31, 0.6); backdrop-filter: blur(10px); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-dark); border: 1px solid rgba(255, 255, 255, 0.05); }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 20px; margin-bottom: 8px; word-wrap: break-word; position: relative; }
        .sent { background-color: var(--primary-color); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .received { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 4px; margin-right: auto; }
        .dark .received { background-color: #374151; color: #e5e7eb; }
        .message-status { position: absolute; bottom: 0; right: 8px; font-size: 10px; opacity: 0; transition: opacity 0.2s; white-space: nowrap; }
        .message-bubble:hover .message-status { opacity: 1; }
        [x-cloak] { display: none !important; }
        .messages-container { height: calc(100vh - 160px); overflow-y: auto; scroll-behavior: smooth; padding: 16px; }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .message-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            cursor: pointer;
            object-fit: cover;
        }
    </style>
</head>
<body x-data="chatManager()" x-init="init()" x-cloak>

    <div class="flex flex-col h-screen max-w-xl mx-auto bento-card">
        
        <header class="flex items-center p-4 shadow-lg sticky top-0 z-10 bento-card rounded-b-xl border-b dark:border-gray-800">
            <a href="chatlist.html" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></a>
            <img :src="photoURL || 'userphoto.jpg'" class="w-10 h-10 rounded-full object-cover ml-3">
            <div class="ml-4 flex-1">
                <h2 class="text-lg font-bold" x-text="displayName"></h2>
                <span id="userStatus" 
                      x-text="isTyping ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : userStatus" 
                      :class="isTyping ? 'text-indigo-500 font-semibold italic' : (userStatus === '–í —Å–µ—Ç–∏' ? 'text-green-500' : 'text-gray-500')" 
                      class="text-sm">
                </span>
            </div>
        </header>

        <div x-ref="messages" class="messages-container flex-1 space-y-2">
            <div x-show="isLoading" class="text-center text-gray-500 dark:text-gray-400 p-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            
            <template x-for="message in messages" :key="message.id">
                <div class="flex" :class="message.senderId === currentUser.uid ? 'justify-end' : 'justify-start'">
                    
                    <div class="message-bubble group" 
                         :class="[message.senderId === currentUser.uid ? 'sent' : 'received', message.type === 'image' ? 'p-1' : '']"
                         @contextmenu.prevent="contextMenuHandler($event, message)"
                         @dblclick="message.type !== 'image' && message.senderId === otherUid ? reactToMessage(message.id, message.reaction) : (message.type !== 'image' && startEdit(message.id, message.text, message.timestamp))">
                        
                        <div x-show="message.reaction === 'like'" 
                             class="absolute -top-3 -right-3 text-2xl transform rotate-12 transition-transform duration-300"
                             :class="message.senderId === currentUser.uid ? 'text-white' : 'text-red-500'">
                             ‚ù§Ô∏è
                        </div>

                        <p x-show="message.type === 'text'" x-text="message.text" class="text-sm" :id="'msg-' + message.id"></p>
                        
                        <div x-show="message.type === 'image'" class="flex flex-col items-end">
                            <img :src="message.imageUrl" class="message-image" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                            <span class="text-xs italic opacity-70 mt-1" :class="message.senderId === currentUser.uid ? 'text-white' : 'text-gray-600 dark:text-gray-300'">–§–æ—Ç–æ</span>
                        </div>
                        
                        <span class="message-status" 
                              :class="{'group-hover:opacity-100': message.senderId === currentUser.uid, 
                                       'text-white': message.type === 'image' && message.senderId === currentUser.uid,
                                       'text-gray-300': message.type === 'image' && message.senderId !== currentUser.uid}">
                            <span x-text="formatTime(message.timestamp)"></span>
                            <span x-show="message.senderId === currentUser.uid && message.readBy?.[otherUid] !== undefined">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="message.readBy?.[otherUid] > message.timestamp ? 'text-green-300' : 'text-gray-300'" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                            </span>
                        </span>
                        
                    </div>
                </div>
            </template>
            <div x-show="messages.length === 0 && !isLoading" class="text-center text-gray-500 dark:text-gray-400 p-8">–ù–∞—á–Ω–∏—Ç–µ —á–∞—Ç!</div>
        </div>

        <div class="p-4 border-t dark:border-gray-800">
             <div x-show="editingMessageId" class="mb-3 p-2 rounded-lg bg-yellow-100 dark:bg-yellow-800 flex justify-between items-center text-sm">
                <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <span x-text="editingOriginalText.substring(0, 20) + '...'"></span></span>
                <button @click="cancelEdit()" class="text-red-600 dark:text-red-400 hover:underline">–û—Ç–º–µ–Ω–∞</button>
            </div>

            <form @submit.prevent="editingMessageId ? saveEdit() : sendMessage()" class="flex gap-3">
                
                <button type="button" @click="showUrlModal = true"
                        class="p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </button>

                <input x-model="newMessage" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required
                       @input.debounce.500ms="setTypingStatus(true)"
                       @keyup.enter.prevent="editingMessageId ? saveEdit() : sendMessage()"
                       class="flex-1 px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                <button type="submit" 
                        :disabled="newMessage.trim() === ''"
                        class="p-3 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 disabled:bg-indigo-300 transition-colors shadow-md">
                    <svg x-show="!editingMessageId" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    <svg x-show="editingMessageId" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                </button>
            </form>
        </div>
        
        <div x-show="contextMenu.visible" @click.away="contextMenu.visible = false" 
             class="fixed z-20 bento-card rounded-lg py-1 shadow-2xl" 
             :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }">
            
            <button x-show="contextMenu.type === 'text'"
                    @click="startEdit(contextMenu.id, contextMenu.text, contextMenu.timestamp)" 
                    class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button @click="deleteMessage(contextMenu.id)" 
                    class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900 transition-colors">
                –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            </button>
        </div>
    </div>
    
    <div x-show="showUrlModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div @click.away="showUrlModal = false" class="bento-card p-6 rounded-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ URL</h3>
            <form @submit.prevent="sendImageUrl">
                <input x-model="imageUrlInput" type="url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (.jpg, .png –∏ —Ç.–¥.)" required
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                
                <div class="mt-4 flex justify-end gap-2">
                    <button type="button" @click="showUrlModal = false" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" :disabled="!imageUrlInput" class="px-4 py-2 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition-colors">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <div x-show="$store.toast.visible" x-transition class="fixed bottom-5 right-5 w-auto max-w-sm p-4 rounded-xl shadow-xl z-50 bento-card font-semibold" :class="$store.toast.type === 'success' ? 'text-green-800 dark:text-green-300 bg-green-500/20' : 'text-red-800 dark:text-red-300 bg-red-500/20'" style="display: none;"><p x-text="$store.toast.message"></p></div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
             const firebaseConfig = {
                        apiKey: "AIzaSyCAOfxPW5m2UqtulWzuh3egOjJ-ti-rDf8",
                        authDomain: "register-221e5.firebaseapp.com",
                        databaseURL: "https://register-221e5-default-rtdb.firebaseio.com",
                        projectId: "register-221e5",
                        storageBucket: "register-221e5.appspot.com",
                        messagingSenderId: "588640206529",
                        appId: "1:588640206529:web:b2abf5413387e251935e40"
                    };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // üü¢ –°–∏—Å—Ç–µ–º–∞ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (—Ñ—É–Ω–∫—Ü–∏—è)
        function setupPresence(user) {
            if (!user) return;
            const uid = user.uid;
            const userLastOnlineRef = database.ref('/users/' + uid + '/lastOnline');
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userLastOnlineRef.set(firebase.database.ServerValue.TIMESTAMP);
                    userLastOnlineRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
        }
        
        // ‚è∞ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–¢–ê–¢–£–°–ê
        function getTimeAgo(timestamp) {
            if (!timestamp) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const seconds = Math.floor((new Date() - timestamp) / 1000);
            if (seconds < 30) return "–í —Å–µ—Ç–∏";
            if (seconds < 60) return "–Ω–µ–¥–∞–≤–Ω–æ";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
            const date = new Date(timestamp);
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }


        document.addEventListener('alpine:init', () => {
            Alpine.store('toast', {
                visible: false, message: '', type: 'success', timer: null,
                show(message, type = 'success') {
                    this.message = message; this.type = type; this.visible = true;
                    clearTimeout(this.timer);
                    this.timer = setTimeout(() => this.visible = false, 4000);
                }
            });
            
            Alpine.data('chatManager', () => ({
                currentUser: null, otherUid: null, conversationId: null,
                displayName: '–ó–∞–≥—Ä—É–∑–∫–∞...', photoURL: 'userphoto.jpg',
                userStatus: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', lastOnlineTimestamp: 0,
                isTyping: false, typingTimeout: null,
                messages: [], newMessage: '', isLoading: true,
                
                // –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
                editingMessageId: null, editingOriginalText: '',
                contextMenu: { visible: false, x: 0, y: 0, id: null, text: null, timestamp: 0, type: 'text' },

                // –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –ø–æ URL
                showUrlModal: false,
                imageUrlInput: '',

                init() {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            this.currentUser = user;
                            setupPresence(user);
                            const urlParams = new URLSearchParams(window.location.search);
                            this.otherUid = urlParams.get('uid');

                            this.conversationId = [this.currentUser.uid, this.otherUid].sort().join('_');
                            this.loadMessages();
                            this.loadOtherUserInfo();
                            this.listenForReadStatus();
                            this.listenForTypingStatus();
                        } else {
                            window.location.href = 'index.html'; 
                        }
                    });
                },
                
                loadOtherUserInfo() {
                    database.ref(`users/${this.otherUid}`).on('value', snapshot => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            this.displayName = data.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                            this.photoURL = data.photoURL || 'userphoto.jpg';
                            this.lastOnlineTimestamp = data.lastOnline || 0;
                            this.userStatus = getTimeAgo(this.lastOnlineTimestamp);
                        } else {
                            this.displayName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω';
                            this.userStatus = '–û—Ñ–ª–∞–π–Ω';
                        }
                    });
                },
                
                loadMessages() {
                    this.isLoading = true;
                    database.ref(`messages/${this.conversationId}`).limitToLast(50).on('value', snapshot => {
                        this.messages = [];
                        snapshot.forEach(childSnapshot => {
                            this.messages.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val(),
                                readBy: childSnapshot.val().readBy || {}
                            });
                        });
                        this.isLoading = false;
                        this.$nextTick(() => {
                            this.markMessagesAsRead();
                            this.scrollToBottom();
                        });
                    });
                },

                // --- –§–£–ù–ö–¶–ò–ò –ü–†–ò–°–£–¢–°–¢–í–ò–Ø ("–ü–ï–ß–ê–¢–ê–ï–¢...") ---
                setTypingStatus(isTyping) {
                    const typingRef = database.ref(`typing/${this.conversationId}/${this.currentUser.uid}`);

                    if (isTyping && this.newMessage.trim().length > 0) {
                        typingRef.set(true);
                        if (this.typingTimeout) clearTimeout(this.typingTimeout);
                        
                        this.typingTimeout = setTimeout(() => {
                            typingRef.set(false);
                            this.typingTimeout = null;
                        }, 2500); 
                    } else if (!isTyping) {
                        typingRef.set(false);
                        if (this.typingTimeout) clearTimeout(this.typingTimeout);
                    }
                },
                
                listenForTypingStatus() {
                    const typingRef = database.ref(`typing/${this.conversationId}/${this.otherUid}`);
                    typingRef.on('value', (snapshot) => {
                        this.isTyping = snapshot.val() === true;
                        if (this.isTyping) this.scrollToBottom(); 
                    });
                },

                // --- –§–£–ù–ö–¶–ò–ò –ß–¢–ï–ù–ò–Ø (READ RECEIPTS) ---
                listenForReadStatus() {
                    database.ref(`conversations/${this.conversationId}/lastMessage/readBy`).on('value', (snapshot) => {
                        this.messages = [...this.messages]; 
                    });
                },

                markMessagesAsRead() {
                    if (this.messages.length === 0) return;
                    
                    const lastMessage = this.messages[this.messages.length - 1];

                    if (lastMessage.senderId === this.otherUid && !lastMessage.readBy?.[this.currentUser.uid]) {
                        
                        const updates = {};
                        const timestamp = firebase.database.ServerValue.TIMESTAMP;
                        const readPath = `readBy/${this.currentUser.uid}`;

                        updates[`/messages/${this.conversationId}/${lastMessage.id}/${readPath}`] = timestamp;
                        updates[`/conversations/${this.conversationId}/lastMessage/${readPath}`] = timestamp;
                        
                        database.ref().update(updates)
                            .catch(e => console.error("Failed to mark message as read:", e));
                    }
                },
                
                // --- –§–£–ù–ö–¶–ò–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø/–£–î–ê–õ–ï–ù–ò–Ø/–õ–ê–ô–ö–û–í ---
                reactToMessage(messageId, currentReaction) {
                    const updates = {};
                    const path = `/messages/${this.conversationId}/${messageId}/reaction`;
                    const newReaction = currentReaction === 'like' ? null : 'like';
                    updates[path] = newReaction;
                    
                    database.ref().update(updates)
                        .catch(e => Alpine.store('toast').show('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏.', 'error'));
                },

                startEdit(messageId, text, timestamp) {
                    const fifteenMinutes = 15 * 60 * 1000;
                    const timeElapsed = new Date().getTime() - timestamp;
                    
                    this.contextMenu.visible = false;
                    
                    if (timeElapsed > fifteenMinutes) {
                        Alpine.store('toast').show('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.', 'error');
                        return;
                    }

                    this.editingMessageId = messageId;
                    this.editingOriginalText = text;
                    this.newMessage = text;
                    this.$nextTick(() => document.querySelector('input[type="text"]').focus());
                },

                cancelEdit() {
                    this.editingMessageId = null;
                    this.editingOriginalText = '';
                    this.newMessage = '';
                },

                saveEdit() {
                    const newText = this.newMessage.trim();
                    if (newText === this.editingOriginalText) {
                        this.cancelEdit();
                        return;
                    }
                    
                    const messageId = this.editingMessageId;
                    
                    const updates = {};
                    updates[`/messages/${this.conversationId}/${messageId}/text`] = newText;
                    updates[`/messages/${this.conversationId}/${messageId}/edited`] = firebase.database.ServerValue.TIMESTAMP;
                    
                    const isLastMessage = this.messages[this.messages.length - 1]?.id === messageId;
                    if (isLastMessage) {
                        updates[`/conversations/${this.conversationId}/lastMessage/text`] = newText;
                    }

                    database.ref().update(updates)
                        .then(() => {
                            Alpine.store('toast').show('–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ!', 'success');
                            this.cancelEdit();
                        })
                        .catch(e => Alpine.store('toast').show('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.', 'error'));
                },

                // –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–Ø
                deleteMessage(messageId) {
                    const fifteenMinutes = 15 * 60 * 1000;
                    const message = this.messages.find(m => m.id === messageId);

                    if (!message) return;
                    
                    const timeElapsed = new Date().getTime() - message.timestamp;
                    
                    if (timeElapsed > fifteenMinutes) {
                        Alpine.store('toast').show('–£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.', 'error');
                        this.contextMenu.visible = false;
                        return;
                    }
                    
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                        database.ref(`/messages/${this.conversationId}/${messageId}`).remove()
                            .then(() => {
                                Alpine.store('toast').show('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!', 'success');
                                this.contextMenu.visible = false;
                                
                                // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è lastMessage –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                                if (this.messages.length > 0 && this.messages[this.messages.length - 1].id === messageId) {
                                    // –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    const prevMessage = this.messages.filter(m => m.id !== messageId).slice(-1)[0];
                                    if (prevMessage) {
                                        database.ref(`/conversations/${this.conversationId}/lastMessage`).set({
                                            text: prevMessage.text,
                                            senderId: prevMessage.senderId,
                                            timestamp: prevMessage.timestamp,
                                            type: prevMessage.type
                                        });
                                    } else {
                                         database.ref(`/conversations/${this.conversationId}/lastMessage`).remove();
                                    }
                                }
                            })
                            .catch(e => Alpine.store('toast').show('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.', 'error'));
                    }
                },
                
                // --- –§–£–ù–ö–¶–ò–ò –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø –ò –§–û–¢–û ---
                async sendMessage(imageUrl = null) {
                    const messageText = this.newMessage.trim();
                    if (!messageText && !imageUrl) return;

                    this.setTypingStatus(false);
                    
                    const messageId = database.ref(`messages/${this.conversationId}`).push().key;
                    const timestamp = firebase.database.ServerValue.TIMESTAMP;
                    const imageUrlRegex = /\.(jpeg|jpg|gif|png|webp)$/i;
                    
                    let messageData = {};
                    let lastMessageText;

                    if (imageUrl) {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                         if (!imageUrl.startsWith('http') || !imageUrlRegex.test(imageUrl)) {
                            Alpine.store('toast').show('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ .jpg/.png.', 'error');
                            return;
                        }
                        messageData = { senderId: this.currentUser.uid, type: 'image', imageUrl: imageUrl, timestamp: timestamp };
                        lastMessageText = 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    } 
                    else if (messageText.startsWith('http') && imageUrlRegex.test(messageText)) {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±)
                        messageData = { senderId: this.currentUser.uid, type: 'image', imageUrl: messageText, timestamp: timestamp };
                        lastMessageText = 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    } 
                    else {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                        messageData = { senderId: this.currentUser.uid, type: 'text', text: messageText, timestamp: timestamp };
                        lastMessageText = messageText;
                    }

                    const updates = {};
                    updates[`/messages/${this.conversationId}/${messageId}`] = messageData;
                    updates[`/conversations/${this.conversationId}/lastMessage`] = {
                        text: lastMessageText,
                        senderId: this.currentUser.uid,
                        timestamp: timestamp,
                        type: messageData.type
                    };

                    try {
                        await database.ref().update(updates);
                        this.newMessage = ''; 
                        this.scrollToBottom();
                        if (imageUrl) this.showUrlModal = false; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –±—ã–ª–æ —Ñ–æ—Ç–æ
                    } catch(err) {
                        Alpine.store('toast').show(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –ë–î.`, 'error');
                        console.error('Message Send Error:', err);
                    }
                },
                
                sendImageUrl() {
                    const url = this.imageUrlInput.trim();
                    if (url) {
                        this.sendMessage(url);
                        this.imageUrlInput = '';
                    }
                },


                // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
                scrollToBottom() {
                    const messagesContainer = this.$refs.messages;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                },
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                },
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                contextMenuHandler(event, message) {
                    // –¢–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    if (message.senderId !== this.currentUser.uid) return;
                    
                    this.contextMenu = {
                        visible: true,
                        x: event.clientX,
                        y: event.clientY,
                        id: message.id,
                        text: message.text,
                        timestamp: message.timestamp,
                        type: message.type
                    };
                }
            }));
        });
    </script>
</body>
</html>
