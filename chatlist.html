<!DOCTYPE html>
<html lang="ru" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–ª–∞–≤–Ω–∞—è - –î–¢–¢</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root { --bg-light: #f7f9fc; --bg-dark: #000000; --card-light: rgba(255, 255, 255, 0.6); --card-dark: #1b1b1b; --border-light: rgba(0, 0, 0, 0.08); --border-dark: rgba(255, 255, 255, 0.12); --text-light: #0f172a; --text-dark: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-light); transition: all 0.5s ease; }
        .dark { background-color: var(--bg-dark); color: var(--text-dark); }
        .bento-card { background-color: var(--card-light); border: 1px solid var(--border-light); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); transition: all 0.3s ease; }
        .dark .bento-card { background-color: var(--card-dark); border: 1px solid var(--border-dark); }
        [x-cloak] { display: none !important; } .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body x-data="homeManager()" x-init="init()" :class="{ 'dark': isDark }" x-cloak>

    <main class="container mx-auto p-4 md:p-6 min-h-screen max-w-3xl">
        
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">–ß–∞—Ç—ã</h1>
            <div class="flex items-center gap-4">
                <a href="notifications.html" class="p-2 rounded-full bento-card hover:bg-gray-500/10 transition-colors relative" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    <span x-show="requestsCount > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center" x-text="requestsCount"></span>
                </a>
                <a href="profile.html" class="p-2 rounded-full bento-card hover:bg-gray-500/10 transition-colors" title="–ü—Ä–æ—Ñ–∏–ª—å"><img :src="currentUser.photoURL || 'userphoto.jpg'" class="w-10 h-10 rounded-full object-cover"></a>
                <button @click="toggleTheme()" class="p-2 rounded-2xl bento-card hover:bg-gray-500/10 transition-colors" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                    <svg x-show="!isDark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <svg x-show="isDark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </button>
            </div>
        </header>

        <div class="bento-card p-4 rounded-3xl mb-6">
            <h2 class="text-xl font-semibold mb-4 px-2">–ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <div class="flex gap-2">
                <input type="text" x-model="searchQuery" 
                       x-on:input.debounce.500ms="searchUser" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ Email –∏–ª–∏ –ò–º–µ–Ω–∏ (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)..." 
                       class="flex-grow bg-gray-100 dark:bg-gray-800 rounded-3xl px-4 py-2 outline-none">
                
                <button @click="searchUser" :disabled="isLoading" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors">
                    <svg x-show="isLoading" class="w-5 h-5 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    <span x-show="!isLoading">–ù–∞–π—Ç–∏</span>
                </button>
            </div>
            
            <div x-show="searchResults.length > 0" class="mt-4 space-y-2">
                <template x-for="result in searchResults" :key="result.uid">
                    <div class="flex items-center justify-between gap-4 p-3 rounded-xl bg-gray-500/10 transition-shadow hover:shadow-md">
                        <div class="flex items-center gap-3">
                            <img :src="result.photoURL || 'userphoto.jpg'" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <h3 class="font-semibold" x-text="result.displayName"></h3>
<p class="text-sm truncate" 
   :class="{'font-bold text-gray-900 dark:text-gray-100': convo.isUnread, 'opacity-60': !convo.isUnread}" 
   x-text="convo.lastMessage.text">
</p>                            </div>
                        </div>
                        <button 
                            @click="sendChatRequest(result.uid)" 
                            :disabled="result.requestSent"
                            class="px-3 py-1 rounded-lg text-sm transition-colors"
                            :class="result.requestSent ? 'bg-gray-400 text-gray-700' : 'bg-green-500 text-white hover:bg-green-600'">
                            <span x-text="result.requestSent ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å'"></span>
                        </button>
                    </div>
                </template>
            </div>
            
            <p x-show="searchMessage" x-text="searchMessage" class="text-sm opacity-70 mt-3"></p>
        </div>


        <div class="bento-card p-4 rounded-2xl">
            <h2 class="text-xl font-semibold mb-4 px-2">–ú–æ–∏ —á–∞—Ç—ã</h2>
            
            <div x-show="isLoading" class="space-y-3 animate-pulse">
                <template x-for="i in 3" :key="i"><div class="flex items-center gap-4 p-2"><div class="w-12 h-12 bg-gray-300 dark:bg-gray-700 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-300 dark:bg-gray-700 rounded w-1/2"></div><div class="h-3 bg-gray-300 dark:bg-gray-700 rounded w-1/3"></div></div></div></template>
            </div>

            <ul x-show="!isLoading && conversations.length > 0" class="space-y-1">
                <template x-for="convo in conversations" :key="convo.id">
                    <li>
                        <a :href="'chat.html?uid=' + convo.otherParticipant.uid" class="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-500/10 transition-colors">
                            <img :src="convo.otherParticipant.photoURL || 'userphoto.jpg'" alt="Avatar" class="w-12 h-12 rounded-full object-cover shadow-sm">
                            <div class="flex-grow overflow-hidden">
                                <div class="flex justify-between">
                                    <h3 class="font-semibold" x-text="convo.otherParticipant.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'"></h3>
                                    <span class="text-xs opacity-60 flex-shrink-0" x-text="formatTimestamp(convo.lastMessage.timestamp)"></span>
                                </div>
                                <p class="text-sm opacity-60 truncate" x-text="convo.lastMessage.text"></p>
                            </div>
                        </a>
                    </li>
                </template>
            </ul>
            <p x-show="!isLoading && conversations.length === 0" class="text-sm opacity-70 px-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤. –í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –±–µ—Å–µ–¥—É.</p>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
       const firebaseConfig = {
                        apiKey: "AIzaSyCAOfxPW5m2UqtulWzuh3egOjJ-ti-rDf8",
                        authDomain: "register-221e5.firebaseapp.com",
                        databaseURL: "https://register-221e5-default-rtdb.firebaseio.com",
                        projectId: "register-221e5",
                        storageBucket: "register-221e5.appspot.com",
                        messagingSenderId: "588640206529",
                        appId: "1:588640206529:web:b2abf5413387e251935e40"
                    };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // üü¢ –°–∏—Å—Ç–µ–º–∞ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (—Ñ—É–Ω–∫—Ü–∏—è)
        function setupPresence(user) {
            if (!user) return;
            const uid = user.uid;
            const userLastOnlineRef = database.ref('/users/' + uid + '/lastOnline');
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userLastOnlineRef.set(firebase.database.ServerValue.TIMESTAMP);
                    userLastOnlineRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('homeManager', () => ({
                isDark: false, isLoading: true, currentUser: {},
                conversations: [], requestsCount: 0,
                searchQuery: '', searchResults: [], searchMessage: '',

                init() {
                    this.isDark = localStorage.getItem('theme') === 'dark';
                    this.setTheme();
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            this.currentUser = user;
                            this.loadConversations();
                            this.listenForRequests();
                            setupPresence(user); 
                        } else {
                            window.location.href = 'index.html'; 
                        }
                    });
                },

                listenForRequests() {
                    const requestsRef = database.ref(`chat_requests/${this.currentUser.uid}`);
                    requestsRef.on('value', (snapshot) => {
                        this.requestsCount = snapshot.numChildren();
                    });
                },

                async loadConversations() {
                    this.isLoading = true;
                    const userConvoRef = database.ref(`user_conversations/${this.currentUser.uid}`);
                    userConvoRef.on('value', async (snapshot) => {
                        if (!snapshot.exists()) { this.isLoading = false; this.conversations = []; return; }
                        const convoIds = Object.keys(snapshot.val());
                        let convos = [];

                        for (const id of convoIds) {
                            const convoRef = database.ref(`conversations/${id}`);
                            const convoSnap = await convoRef.once('value');
                            if (!convoSnap.exists()) continue;
                            const convoData = convoSnap.val();
                            
                            const otherUid = Object.keys(convoData.participants).find(uid => uid !== this.currentUser.uid);
                            if (!otherUid) continue;

                            const userSnap = await database.ref(`users/${otherUid}`).once('value');
                            const userData = userSnap.val() || { displayName: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', photoURL: '' };
                            
                           // –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞)
convos.push({
    id: id,
    lastMessage: convoData.lastMessage || { text: '–ù–∞—á–∞—Ç—å —á–∞—Ç', timestamp: convoData.createdAt || 0 },
    otherParticipant: { uid: otherUid, ...userData }
});
                        }
                        this.conversations = convos.sort((a, b) => b.lastMessage.timestamp - a.lastMessage.timestamp);
                        this.isLoading = false;
                    });
                },

                async searchUser() {
                    const query = this.searchQuery.trim().toLowerCase();
                    this.searchMessage = '';
                    this.searchResults = [];

                    if (query.length < 3) {
                        if (query.length > 0) { this.searchMessage = '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.'; }
                        return;
                    }
                    
                    this.isLoading = true;

                    // –ü–æ–∏—Å–∫ –ø–æ email (–ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É)
                    const emailSnap = await database.ref('users').orderByChild('email').startAt(query).endAt(query + '\uf8ff').once('value');

                    const results = [];
                    emailSnap.forEach(childSnap => {
                        const userData = childSnap.val();
                        const uid = childSnap.key;

                        if (uid === this.currentUser.uid) return; 

                        const displayNameLower = (userData.displayName || '').toLowerCase();
                        
                        if (userData.email.toLowerCase().startsWith(query) || displayNameLower.includes(query)) {
                            results.push({ uid: uid, ...userData, requestSent: false });
                        }
                    });

                    if (results.length > 0) {
                        this.searchResults = results;
                    } else {
                        this.searchMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
                    }

                    this.isLoading = false;
                },

                sendChatRequest(recipientId) {
                    const requestRef = database.ref(`chat_requests/${recipientId}/${this.currentUser.uid}`);
                    
                    this.searchResults = this.searchResults.map(r => r.uid === recipientId ? { ...r, requestSent: true } : r);
                    
                    requestRef.set(firebase.database.ServerValue.TIMESTAMP)
                        .then(() => { this.searchMessage = '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ‚úÖ'; })
                        .catch((err) => {
                            this.searchMessage = '–û—à–∏–±–∫–∞: ' + err.message;
                            this.searchResults = this.searchResults.map(r => r.uid === recipientId ? { ...r, requestSent: false } : r);
                        });
                },
                
                formatTimestamp(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                },

                setTheme() { document.documentElement.classList.toggle('dark', this.isDark); },
                toggleTheme() { this.isDark = !this.isDark; localStorage.setItem('theme', this.isDark ? 'dark' : 'light'); this.setTheme(); },
            }));
        });
    </script>
</body>
</html>
